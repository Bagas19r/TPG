---
title: "Analisis Gerombol Provinsi Berdasarkan Harga 15 Pangan Strategis"
subtitle: "Tugas Akhir Teknik Pengolahan Data/Peubah Ganda"
author: "Muhammad Bagas Ramadhan G1401231109"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
# Pastikan library terinstall
# install.packages(c("tidyverse", "cluster", "factoextra", "knitr", "kableExtra"))
library(ggpubr, lib.loc = "~/R/libs")
library(purrr, lib.loc = "~/R/libs")
library(ggplot2, lib.loc = "~/R/libs")
library(tidyverse, lib.loc = "~/R/libs")
library(cluster)
library(factoextra, lib.loc = "~/R/libs")
library(knitr)
library(kableExtra, lib.loc = "~/R/libs")
library(readr)
library(dplyr)
library(stringr)
library(tibble)
library(ggsci, lib.loc = "~/R/libs")
library(tidyr)
```

# Pendahuluan

Laporan ini bertujuan untuk mengelompokkan 34 Provinsi di Indonesia berdasarkan kemiripan karakteristik harga pada 15 komoditas pangan strategis. Data yang digunakan merupakan data snapshot harian terbaru yang bersumber dari Badan Pangan Nasional (Bapanas).

# Preparasi Data

## Membaca dan Menggabungkan Data

```{r}
# 1. Tentukan Lokasi Folder (Sesuai info Anda)
folder_path <- "C:/Users/AKU/Downloads/TugasAkhir_TPG"

# 2. Mendapatkan daftar file CSV
file_list <- list.files(path = folder_path, pattern = "\\.csv$", full.names = TRUE)

# Cek apakah file ditemukan
if(length(file_list) == 0) {
  stop("Tidak ada file CSV ditemukan! Pastikan path folder sudah benar.")
}

# 3. Fungsi Pembersih Data CSV
read_clean_csv <- function(filepath) {
  # Ambil nama produk dari nama file
  product_name <- tools::file_path_sans_ext(basename(filepath))
  
  # Langkah A: Coba baca dengan pemisah KOMA (Standar Internasional)
  df <- read_csv(filepath, show_col_types = FALSE)
  
  # Langkah B: Cek jika pembacaan gagal (kolom jadi cuma 1), coba pakai TITIK KOMA (Format Excel Indo)
  if(ncol(df) <= 1) {
    df <- read_csv2(filepath, show_col_types = FALSE)
  }
  
  # Langkah C: Logika Pintar Memilih Kolom
  # Jika total kolom cuma 2, berarti isinya [Provinsi, Harga] -> Ambil kolom 1 & 2
  # Jika total kolom > 2, berarti isinya [No, Provinsi, Harga] -> Ambil kolom 2 & 3
  if(ncol(df) == 2) {
    target_cols <- c(1, 2)
  } else {
    target_cols <- c(2, 3)
  }
  
  # Proses Seleksi dan Pembersihan
  df_selected <- df %>%
    select(all_of(target_cols)) %>% 
    set_names(c("Provinsi", "Harga"))
  
  # Bersihkan kolom Harga
  df_clean <- df_selected %>%
    mutate(
      Harga = as.character(Harga), 
      Harga = str_remove_all(Harga, "[^0-9]"), # Hapus Rp, titik, koma
      Harga = as.numeric(Harga) 
    ) %>%
    # Ganti nama kolom Harga jadi Nama Produk
    rename(!!product_name := Harga)
  
  return(df_clean)
}

# 4. Loop membaca semua file dan menggabungkannya
data_raw <- file_list %>%
  lapply(read_clean_csv) %>%
  reduce(full_join, by = "Provinsi")

# Tampilkan data awal
head(data_raw) %>%
  kable(caption = "Cuplikan Data Mentah Gabungan") %>%
  kable_styling(bootstrap_options = "striped", font_size = 11)
```

## Penanganan Missing Value (Imputasi Wilayah)

```{r}
# 1. Membuat Kamus Pulau (Mapping Provinsi ke Pulau)
data_w_island <- data_raw %>%
  mutate(Pulau = case_when(
    grepl("Aceh|Sumatera|Riau|Jambi|Bengkulu|Lampung|Bangka|Kepulauan Riau", Provinsi, ignore.case = T) ~ "Sumatera",
    grepl("Jakarta|Jawa|Banten|Yogyakarta", Provinsi, ignore.case = T) ~ "Jawa",
    grepl("Bali|Nusa", Provinsi, ignore.case = T) ~ "BaliNusa",
    grepl("Kalimantan", Provinsi, ignore.case = T) ~ "Kalimantan",
    grepl("Sulawesi|Gorontalo", Provinsi, ignore.case = T) ~ "Sulawesi",
    grepl("Maluku|Papua", Provinsi, ignore.case = T) ~ "MalukuPapua",
    TRUE ~ "Lainnya"
  ))

# 2. Proses Imputasi
data_clean <- data_w_island %>%
  group_by(Pulau) %>%
  # Isi NA dengan rata-rata Pulau tersebut
  mutate(across(where(is.numeric), ~ifelse(is.na(.), mean(., na.rm = TRUE), .))) %>%
  ungroup() %>%
  # Jika masih ada NA (misal satu pulau kosong semua), isi dengan Rata-rata Nasional
  mutate(across(where(is.numeric), ~ifelse(is.na(.), mean(., na.rm = TRUE), .))) %>%
  select(-Pulau) %>% # Hapus kolom pulau
  filter(!is.na(Provinsi)) # Hapus baris jika ada nama provinsi kosong

# Cek apakah masih ada NA
cat("Jumlah Missing Value tersisa:", sum(is.na(data_clean)))
```

# Analisis Cluster (K-Means)

## Standarisasi Data

```{r}
# Set Provinsi sebagai nama baris (rownames)
data_final <- data_clean %>% 
  column_to_rownames("Provinsi")

# Scale data
data_scaled <- scale(data_final)
```

## Menentukan Jumlah Cluster Optimal

Menggunakan metode Elbow untuk mencari k terbaik.

```{r}
fviz_nbclust(data_scaled, kmeans, method = "wss") +
  geom_vline(xintercept = 3, linetype = 2) +
  labs(title = "Metode Elbow: Penentuan Jumlah Cluster")
```

# Eksekusi K-Means

```{r}
set.seed(123) 
k <- 3
km_res <- kmeans(data_scaled, centers = k, nstart = 25)

# Visualisasi Cluster
fviz_cluster(km_res, data = data_scaled,
             palette = "jco",
             ggtheme = theme_minimal(),
             main = "Peta Sebaran Cluster Harga Pangan",
             repel = TRUE)
```

# Analisis Biplot

Biplot digunakan untuk memvisualisasikan hubungan antar peubah (harga komoditas) dan posisi objek (provinsi) dalam ruang dua dimensi.

```{r biplot, fig.height=8, fig.width=10}
# 1. Menghitung Komponen Utama (PCA)
# Kita gunakan data yang sudah distandarisasi (data_scaled)
res.pca <- prcomp(data_scaled, scale = FALSE)

# 2. Membuat Biplot
fviz_pca_biplot(res.pca,
                # Warnai titik Provinsi berdasarkan Cluster yang sudah terbentuk
                col.ind = as.factor(km_res$cluster), 
                palette = "jco",
                
                # Pengaturan Tampilan
                geom.ind = c("point", "text"), # Tampilkan titik dan teks nama provinsi
                geom.var = c("arrow", "text"), # Tampilkan panah dan teks komoditas
                repel = TRUE,                  # Agar tulisan tidak saling tumpuk
                
                # Label dan Judul
                legend.title = "Cluster",
                title = "Biplot: Peta Hubungan Provinsi dan Harga Komoditas"
                )
```

# Interpretasi Hasil

```{r}
# Gabungkan hasil cluster ke data harga asli
hasil_profil <- data_final %>%
  mutate(Cluster = as.factor(km_res$cluster)) %>%
  group_by(Cluster) %>%
  summarise(across(everything(), mean)) %>%
  mutate(across(where(is.numeric), round, 0)) # Bulatkan angka

# Transpose agar mudah dibaca per komoditas
hasil_profil_t <- hasil_profil %>%
  pivot_longer(cols = -Cluster, names_to = "Komoditas", values_to = "Harga_Rata2") %>%
  pivot_wider(names_from = Cluster, values_from = Harga_Rata2, names_prefix = "Cluster ")

kable(hasil_profil_t, caption = "Profil Rata-rata Harga per Cluster (Rupiah)") %>%
  kable_styling(bootstrap_options = "hover")
```

# Kesimpulan

## Berdasarkan hasil analisis gerombol menggunakan metode K-Means terhadap 34 provinsi dan 15 komoditas pangan, dapat disimpulkan bahwa:

1. Terbentuk *3 kelompok wilayah* dengan karakteristik harga yang berbeda nyata.

2. *Cluster 2* merupakan wilayah dengan stabilitas harga pangan terbaik (termurah), yang didominasi oleh provinsi sentra produksi di Jawa dan Sumatera.

3. *Cluster 3* (Wilayah Papua dan sekitarnya) mengalami disparitas harga yang ekstrem, terutama pada komoditas Cabai dan Bawang, dengan selisih harga mencapai 2 kali lipat lebih tinggi dibandingkan wilayah Jawa.

4. *Analisis Biplot* mengonfirmasi bahwa peubah *Cabai Rawit Merah*, *Bawang Merah*, dan *Ikan* memiliki korelasi positif yang kuat dan menjadi pembeda utama yang mencirikan mahalnya harga pangan di wilayah Cluster 3.